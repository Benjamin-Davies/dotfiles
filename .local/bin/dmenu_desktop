#!/usr/bin/env python3

import re
from glob import glob
from subprocess import PIPE, Popen, call
from sys import argv


def parse_desktop_file(fn):
    table = {}
    with open(fn, 'r') as fd:
        for l in fd:
            if '=' not in l:
                continue
            i = l.index('=')
            key = l[:i]
            value = l[i+1 : -1]
            table[key] = value
    return table

files = glob('/usr/share/applications/*.desktop')
apps = [ parse_desktop_file(f) for f in files ]
# ends with \n for interaction with dmenu command
app_names = [ a['Name'] + '\n' for a in apps ]
app_table = dict(zip(app_names, apps))

proc = Popen(['dmenu', '-p', 'Apps:'] + argv[1:], stdin=PIPE, stdout=PIPE)
result, _ = proc.communicate(''.join(app_names).encode('UTF-8'))
result = result.decode('UTF-8')

if result != '\n':
    app = app_table[result]
    cmd = re.sub(r' %\w', '', app['Exec'])
    print(cmd)

    if app['Terminal'] == 'true':
        call(['alacritty', '-e', cmd])
    else:
        call(cmd, shell=True)
